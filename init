#!/usr/bin/bash

# Sorry for the inconvenience, but since this script has to be
# sourced it can't determine its own home (AFAIK)
MyHome=~/aquaPI

# 'basename $0' produces '-bash' on Debian/Rasberry OS ! why?? Skip the check!
if [[ ! "grep -i debian /usr/lib/os-release" ]]
then
  if [[ `basename $0` = "init" ]]
  then
    echo "ERROR: this script must be sourced: '. ${MyHome}/init'"
    fi
fi

if [[ ! -d ${MyHome}/venv ]]
then
  echo "First time init of aquaPi development env."
  read -p "CR to continue / Ctrl-C to cancel" dummy
  cd ${MyHome}
  # Debian derivatives don't come with py3 venv by default
  grep -i debian /usr/lib/os-release && sudo apt-get install python3-venv
  python3 -m venv venv
fi

echo "Activate aquaPi development env."
cd ${MyHome}
. ./venv/bin/activate
echo ===== get all python modules
pip3 install -r requirements.txt
echo =====

echo "There are two scripts to run the development server:"
echo "  './run' should be used to start the software in a SSH"
echo "     shell, termination of the shell will not hang up (HUP)"
echo "     the process, and output is tee-ed to run.log"
echo "  './dbg' starts without output redirect to allow debugger"
echo "     interaction. If used via SSH the process will die"
echo "     when you close the shell."
echo "Use your browser to see the UI at 'http://$(hostname -i):5000'"
